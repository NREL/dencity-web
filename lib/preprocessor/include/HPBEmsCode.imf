##def BaselineAhuControl_WarmupCooldwn[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH_OPT,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH_OPT,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  NightOperation_Sch_OPT,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd_OPT,
  HVACOperationSchd_OPT,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.556,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.556;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    ! If we can economize, set OA flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd_OPT = 1.0, !** CHANGED FOR WARMUP/COOLDOWN OPT 
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;
!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef


##def BaselineAhuControl[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

!** Original Schedules 

Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    ! If we can economize, set OA flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;
  
!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef

##def SteppedAhuControl[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

!** Original schedules 

Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    ! The following section of code is used to predict T_supply_air. The equation used is of the following form:
    !                (T_outdoor_air * Vdot_outdoor_air) + (T_return_air * Vdot_return_air) 
    !T_supply_air =  --------------------------------------------------------------------- + DeltaT_across_fan [assumed to be 0.5 F]
    !                                 (Vdot_outdoor_air + Vdot_return_air)
    Set #{ZoneName}_TSupplyPredict1 = #{ZoneName}_OAFlow * #{ZoneName}_OA_db,
    Set #{ZoneName}_TSupplyPredict2 = #{ZoneName}_AirFlowRate - #{ZoneName}_OAFlow,
    Set #{ZoneName}_TSupplyPredict3 = #{ZoneName}_TSupplyPredict2 * #{ZoneName}_TZone,
    Set #{ZoneName}_TSupplyPredict4 = #{ZoneName}_TSupplyPredict1 + #{ZoneName}_TSupplyPredict3,
    Set #{ZoneName}_TSupplyPredict5 = #{ZoneName}_TSupplyPredict4 / #{ZoneName}_AirFlowRate,
    Set #{ZoneName}_TSupplyPredict = #{ZoneName}_TSupplyPredict5 + 0.2778,
    IF #{ZoneName}_TSupplyPredict < 10.0 && #{ZoneName}_NightOperation > 0.0, ! Check to see if RTU is supplying air that is too cold (< 50 F).
      ! If the RTU is cold dumping (supplying air less than 50 F), determine the amount of SA required to ensure that the supply air
      ! temperature is 50 F (this is done by increasing the amount of return air from the zone, since the outdoor air volume flow rate is
      ! fixed at minimum while the zone is floating. The equation used to predict the requird amount of supply air is of the following form:
      !                    Vdot_outdoor_air * (T_outdoor_air - T_supply_air [set to 50 F in this case] - DeltaT_across_fan [assumed to be 0.5 F])
      ! Vdot_supply air =  ---------------------------------------------------------------------------------------------------------------------- + Vdot_outdoor_air
      !                            (T_supply_air [set to 50 F in this case] + DeltaT_across_fan [assumed to be 0.5 F] - T_return_air)
      Set #{ZoneName}_Temp_Numerator = (#{ZoneName}_OA_db + 273.15) - 283.15 + 0.27778,
      Set #{ZoneName}_Numerator = #{ZoneName}_OAFlow * #{ZoneName}_Temp_Numerator,
      Set #{ZoneName}_Denominator = 283.15 - 0.27778 - (#{ZoneName}_TZone + 273.15),
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator) + #{ZoneName}_OAFlow,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_80Flow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ELSEIF #{ZoneName}_AirFlowRate > #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      ELSEIF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    ! If we can economize, set OA flow and fan total flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef

##def VariableAhuControl[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TSupply,
  #{SystemName} Supply Equipment Outlet Node,
  System Node Temp;
  
!** Original Schedules
  
Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285 * #{ZoneName}_wb) + (0.0013562 * (#{ZoneName}_wb^2)),
  SET Part4 = (0.009934 * #{ZoneName}_OA_db) + (0.0006398 * (#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690 * #{ZoneName}_wb * #{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode, 
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    ! The following section of code is used to predict T_supply_air. The equation used is of the following form:
    !                (T_outdoor_air * Vdot_outdoor_air) + (T_return_air * Vdot_return_air) 
    !T_supply_air =  --------------------------------------------------------------------- + DeltaT_across_fan [assumed to be 0.5 F]
    !                                 (Vdot_outdoor_air + Vdot_return_air)
    Set #{ZoneName}_TSupplyPredict1 = #{ZoneName}_OAFlow * #{ZoneName}_OA_db,
    Set #{ZoneName}_TSupplyPredict2 = #{ZoneName}_AirFlowRate - #{ZoneName}_OAFlow,
    Set #{ZoneName}_TSupplyPredict3 = #{ZoneName}_TSupplyPredict2 * #{ZoneName}_TZone,
    Set #{ZoneName}_TSupplyPredict4 = #{ZoneName}_TSupplyPredict1 + #{ZoneName}_TSupplyPredict3,
    Set #{ZoneName}_TSupplyPredict5 = #{ZoneName}_TSupplyPredict4 / #{ZoneName}_AirFlowRate,
    Set #{ZoneName}_TSupplyPredict = #{ZoneName}_TSupplyPredict5 + 0.2778,
    IF #{ZoneName}_TSupplyPredict < 10.0 && #{ZoneName}_NightOperation > 0.0, ! Check to see if RTU is supplying air that is too cold (< 50 F).
      ! If the RTU is cold dumping (supplying air less than 50 F), determine the amount of SA required to ensure that the supply air
      ! temperature is 50 F (this is done by increasing the amount of return air from the zone, since the outdoor air volume flow rate is
      ! fixed at minimum while the zone is floating. The equation used to predict the requird amount of supply air is of the following form:
      !                    Vdot_outdoor_air * (T_outdoor_air - T_supply_air [set to 50 F in this case] - DeltaT_across_fan [assumed to be 0.5 F])
      ! Vdot_supply air =  ---------------------------------------------------------------------------------------------------------------------- + Vdot_outdoor_air
      !                            (T_supply_air [set to 50 F in this case] + DeltaT_across_fan [assumed to be 0.5 F] - T_return_air)
      Set #{ZoneName}_Temp_Numerator = (#{ZoneName}_OA_db + 273.15) - 283.15 + 0.27778,
      Set #{ZoneName}_Numerator = #{ZoneName}_OAFlow * #{ZoneName}_Temp_Numerator,
      Set #{ZoneName}_Denominator = 283.15 - 0.27778 - (#{ZoneName}_TZone + 273.15),
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator) + #{ZoneName}_OAFlow,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_MaxFanSp,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ENDIF,
      IF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0, ! Check to see if we can economize.
      ! If we can economize, set OA flow and fan total flow equal to max fan flow rate (i.e. damper 100% open).
      ! NO ACTIVE COOLING IN THIS CASE.
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    IF #{ZoneName}_OAFlow > 0.0,
      Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_db - #{ZoneName}_TSupply,
      ! If the CC was off for the previous timestep, we need to reasonably predict what the delta T across the 
      ! coil will be (since it is not valid to look at the previous timestep value, as the CC was off). If this
      ! is the case, set the assumed delta T to 10.0 C. This delta T is assumed to be reasonable (much more 
      ! reasonable than a negative value at least).
      IF #{ZoneName}_CC_PrevDelta < 0.0,
        Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_CC_PrevDeltaPrime / #{ZoneName}_AirFlowRate,
      ELSE,
        Set #{ZoneName}_CC_PrevDeltaPrime = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
      ENDIF,
      ! The following section of code is used to predict what SA flow rate is required in order to deliver
      ! SA at 55 F (12.7778 C). The equation used is of the following form:
      !                    (T_return_air * Vdot_outdoor_air) - (T_outdoor_air * Vdot_outdoor_air) + (DeltaT_across_CC_at_previous_timestep * Vdot_across_CC_at_previous_timestep)
      ! Vdot_supply air =  ------------------------------------------------------------------------------------------------------------------------------------------------------
      !                                                                     (T_return_air - T_supply_air [T_supply_air is set to 55 F in this case])
      Set #{ZoneName}_Numerator1 = (#{ZoneName}_TZone + 273.15) * #{ZoneName}_OAFlow,
      Set #{ZoneName}_Numerator2 = (#{ZoneName}_OA_db + 273.15) * #{ZoneName}_OAFlow,
      Set #{ZoneName}_Numerator3 = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_Numerator4 = #{ZoneName}_Numerator1 - #{ZoneName}_Numerator2,
      Set #{ZoneName}_Numerator = #{ZoneName}_Numerator3 + #{ZoneName}_Numerator4,
      Set #{ZoneName}_Denominator = (#{ZoneName}_TZone + 273.15) - 285.93,
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator),
      ELSE,
      	Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_db - #{ZoneName}_TSupply,
	Set #{ZoneName}_Numerator = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
	Set #{ZoneName}_Denominator = (#{ZoneName}_TZone + 273.15) - 285.93,
        Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator),
      ENDIF,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_MaxFanSp, ! Check to prevent a fan flow greater than what the fan can supply.
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ENDIF,
      IF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow, ! Check to prevent a fan flow less than the minimum required for comfort and ventilation.
	Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
      Set #{ZoneName}_CoolingPowerModifier = 0.5, ! Set the cooling coil to act as if only one compressor is running (i.e. Stage 1).
    ENDIF,
    RUN #{ZoneName}_HeatOff, ! Make sure heating is off.
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;
  
EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency
##enddef

##def LimitAirSystemSizeToCoolingDesignFlow[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizeForCoolingOnly_Program1,
  EndOfSystemSizing,
  #{ZoneName}_SizeForCoolingOnly;

EnergyManagementSystem:InternalVariable, 
  #{SystemName}_CoolVdot,
  #{SystemName},
  Intermediate Air System Cooling Volume Flow Rate;

EnergyManagementSystem:InternalVariable, 
  #{SystemName}_HeatVdot,
  #{SystemName},
  Intermediate Air System Heating Volume Flow Rate;  

EnergyManagementSystem:Actuator,
  #{SystemName}_MainVdotSet,
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:GlobalVariable, 
  #{SystemName}_RatHeatToCoolVdot;

EnergyManagementSystem:Program,
  #{ZoneName}_SizeForCoolingOnly,
  Set #{SystemName}_MainVdotSet = #{SystemName}_CoolVdot,
  Set dum = #{SystemName}_HeatVdot / #{SystemName}_CoolVdot,
  Set #{SystemName}_RatHeatToCoolVdot = dum;


##enddef

##def OaNodeTemp[]


EnergyManagementSystem:Sensor,
  #{CleanSystemName}_Ambient_Temp_Sensor,  !- Name
  Environment,  !- Output:Variable or Output:Meter Index Key Name
  Outdoor Dry Bulb;  !- Output:Variable or Output:Meter Name

EnergyManagementSystem:Actuator,
  #{CleanSystemName}_OA_Inlet_Node_Actuator,  !- Name
  #{SystemName}_OAInlet Node,  !- Actuated Component Unique Name
  Outdoor Air System Node,  !- Actuated Component Type
  Drybulb Temperature;  !- Actuated Component Control Type

EnergyManagementSystem:ProgramCallingManager,
  #{CleanSystemName}_Control_Manager_1,  !- Name
  InsideHVACSystemIterationLoop,  !- EnergyPlus Model Calling Point
  #{CleanSystemName}_OA_Inlet_Temp_Control;  !- Program Name 1

EnergyManagementSystem:Program,
  #{CleanSystemName}_OA_Inlet_Temp_Control,  !- Name
  SET #{CleanSystemName}_OA_Inlet_Node_Actuator = NULL,  !- Program Line
  SET #{CleanSystemName}_OA_Inlet_Node_Actuator = (#{CleanSystemName}_Ambient_Temp_Sensor - 2.78);  !- Program Line


##enddef
##def BaselineAhuControl_Tgt_Sales[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def BaselineAhuControl_Tgt_Base[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def BaselineAhuControl_Tgt_Stock[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  STOCK_HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  STOCK_CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def SteppedAhuControl_Tgt_Sales[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  SALESOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 1.0,
  Until: 23:00, 1.0,
  Until: 24:00, 1.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def SteppedAhuControl_Tgt_Base[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def SteppedAhuControl_Tgt_Stock[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  STOCK_HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  STOCK_CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def BaselineAhuControl_Tgt_Base_wEvapCond[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_wb,
  ,
  Outdoor Wet Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  SET EvapEffective = 0.8,
  SET #{ZoneName}_OA_db = #{ZoneName}_OA_wb + (#{ZoneName}_OA_db - #{ZoneName}_OA_wb) * (1.0 - EvapEffective),
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def SteppedAhuControl_Tgt_Sales_wEvapCond[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_wb,
  ,
  Outdoor Wet Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  SALESOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 1.0,
  Until: 23:00, 1.0,
  Until: 24:00, 1.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  SET EvapEffective = 0.8,
  SET #{ZoneName}_OA_db = #{ZoneName}_OA_wb + (#{ZoneName}_OA_db - #{ZoneName}_OA_wb) * (1.0 - EvapEffective),
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def SteppedAhuControl_Tgt_Base_wEvapCond[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_wb,
  ,
  Outdoor Wet Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  SET EvapEffective = 0.8,
  SET #{ZoneName}_OA_db = #{ZoneName}_OA_wb + (#{ZoneName}_OA_db - #{ZoneName}_OA_wb) * (1.0 - EvapEffective),
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def SteppedAhuControl_Tgt_Stock_wEvapCond[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_Fan_RatedVDot, 
  #{SystemName}_Fan,
  Fan,
  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_wb,
  ,
  Outdoor Wet Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

! ********* GENERIC CODE for SCHEDULE - START HERE

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  STOCK_HTGSETP_SCH,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  STOCK_CLGSETP_SCH,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;  

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_THeat1SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool2SP;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_TCool3SP;  

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_TempScheduleSet_CallingManager,
  BeginTimestepBeforePredictor,
  #{ZoneName}_TempScheduleSet;

EnergyManagementSystem:Program,
  #{ZoneName}_TempScheduleSet,
  SET #{ZoneName}_THeat1SP = #{ZoneName}_THeatSP - 0.278,
  SET #{ZoneName}_TCool2SP = #{ZoneName}_TCool1SP + 0.278,
  SET #{ZoneName}_TCool3SP = #{ZoneName}_TCool1SP + 2*0.278;
  
Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Fraction,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;
 
! ****** END NEW CODEING **** 

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignCoolingLoad,
  #{ZoneName},
  Final Zone Design Cooling Load;

EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set TargetCFMperTon = 375, 
  Set convertFlowPerCap = 7452100, 
  Set TargetM3perSecperWatt = TargetCFMperTon / convertFlowPerCap , 
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_DesignCoolingLoad / #{ZoneName}_RatedSHR,
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt,
  Set #{ZoneName}_Fan_RatedVdot = #{ZoneName}_RatedTotCap * TargetM3perSecperWatt;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  SET EvapEffective = 0.8,
  SET #{ZoneName}_OA_db = #{ZoneName}_OA_wb + (#{ZoneName}_OA_db - #{ZoneName}_OA_wb) * (1.0 - EvapEffective),
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FT_Curve = #{ZoneName}_CC_FT_Curve * #{ZoneName}_CoolingPowerModifier,  
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = 0.0;

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Float
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Economizer mode
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 2.0, ! First stage cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.5,
  ELSEIF #{ZoneName}_mode == 3.0, ! Second stage cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate * #{ZoneName}_NightOperation,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 4.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.277778, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.277778,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 4.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 4.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool3SP, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
  IF #{ZoneName}_TZone < #{ZoneName}_THeat1SP,
    Set #{ZoneName}_mode = 4.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool3SP,
    Set #{ZoneName}_mode = 3.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP, 
    Set #{ZoneName}_mode = 2.0,
  ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,  !- 65 degree economizer shutoff
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ELSE,
    Set #{ZoneName}_mode = 0.0,
  ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;


##enddef

##def BaselineAhuControlOneCFMPerft2[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_ZoneFlowSizingIntervention,
  EndofZoneSizing,
  #{ZoneName}_ZoneFlowSizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SysFlowSizingIntervention,
  EndofSystemSizing,
  #{ZoneName}_SysFlowSizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
!EnergyManagementSystem:Actuator,
!  #{ZoneName}_Fan_RatedVDot, 
!  #{SystemName}_Fan,
!  Fan,
!  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

!** Original Schedules 

Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Area,
  #{ZoneName},
  Zone Floor Area;

EnergyManagementSystem:Actuator,
  #{ZoneName}_ZoneFanFlowRateOverride, 
  #{ZoneName},
  Sizing:Zone,
  Zone Design Cooling Vol Flow;

EnergyManagementSystem:Actuator,
  #{ZoneName}_SysFanFlowRateOverride, 
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:Program,
  #{ZoneName}_ZoneFlowSizingIntervention,
  Set #{ZoneName}_ZoneFanFlowRateOverride = #{ZoneName}_Area * 0.00508;

EnergyManagementSystem:Program,
  #{ZoneName}_SysFlowSizingIntervention,
  Set #{ZoneName}_SysFanFlowRateOverride = #{ZoneName}_Area * 0.00508;
  
EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_Area * 100.95, ! Set cooling capacity equal to 375 ft^2/ton (gross)
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_Area * 0.00508;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    ! If we can economize, set OA flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
   RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;
  
!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef

##def SteppedAhuControlOneCFMPerft2[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_ZoneFlowSizingIntervention,
  EndofZoneSizing,
  #{ZoneName}_ZoneFlowSizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SysFlowSizingIntervention,
  EndofSystemSizing,
  #{ZoneName}_SysFlowSizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
!EnergyManagementSystem:Actuator,
!  #{ZoneName}_Fan_RatedVDot, 
!  #{SystemName}_Fan,
!  Fan,
!  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

!** Original schedules 

Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Area,
  #{ZoneName},
  Zone Floor Area;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_ZoneFanFlowRateOverride, 
  #{ZoneName},
  Sizing:Zone,
  Zone Design Cooling Vol Flow;

EnergyManagementSystem:Actuator,
  #{ZoneName}_SysFanFlowRateOverride, 
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:Program,
  #{ZoneName}_ZoneFlowSizingIntervention,
  Set #{ZoneName}_ZoneFanFlowRateOverride = #{ZoneName}_Area * 0.00508;

EnergyManagementSystem:Program,
  #{ZoneName}_SysFlowSizingIntervention,
  Set #{ZoneName}_SysFanFlowRateOverride = #{ZoneName}_Area * 0.00508;
  
EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_Area * 100.95, ! Set cooling capacity equal to 375 ft^2/ton (gross)
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_Area * 0.00508;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    ! The following section of code is used to predict T_supply_air. The equation used is of the following form:
    !                (T_outdoor_air * Vdot_outdoor_air) + (T_return_air * Vdot_return_air) 
    !T_supply_air =  --------------------------------------------------------------------- + DeltaT_across_fan [assumed to be 0.5 F]
    !                                 (Vdot_outdoor_air + Vdot_return_air)
    Set #{ZoneName}_TSupplyPredict1 = #{ZoneName}_OAFlow * #{ZoneName}_OA_db,
    Set #{ZoneName}_TSupplyPredict2 = #{ZoneName}_AirFlowRate - #{ZoneName}_OAFlow,
    Set #{ZoneName}_TSupplyPredict3 = #{ZoneName}_TSupplyPredict2 * #{ZoneName}_TZone,
    Set #{ZoneName}_TSupplyPredict4 = #{ZoneName}_TSupplyPredict1 + #{ZoneName}_TSupplyPredict3,
    Set #{ZoneName}_TSupplyPredict5 = #{ZoneName}_TSupplyPredict4 / #{ZoneName}_AirFlowRate,
    Set #{ZoneName}_TSupplyPredict = #{ZoneName}_TSupplyPredict5 + 0.2778,
    IF #{ZoneName}_TSupplyPredict < 10.0 && #{ZoneName}_NightOperation > 0.0, ! Check to see if RTU is supplying air that is too cold (< 50 F).
      ! If the RTU is cold dumping (supplying air less than 50 F), determine the amount of SA required to ensure that the supply air
      ! temperature is 50 F (this is done by increasing the amount of return air from the zone, since the outdoor air volume flow rate is
      ! fixed at minimum while the zone is floating. The equation used to predict the requird amount of supply air is of the following form:
      !                    Vdot_outdoor_air * (T_outdoor_air - T_supply_air [set to 50 F in this case] - DeltaT_across_fan [assumed to be 0.5 F])
      ! Vdot_supply air =  ---------------------------------------------------------------------------------------------------------------------- + Vdot_outdoor_air
      !                            (T_supply_air [set to 50 F in this case] + DeltaT_across_fan [assumed to be 0.5 F] - T_return_air)
      Set #{ZoneName}_Temp_Numerator = (#{ZoneName}_OA_db + 273.15) - 283.15 + 0.27778,
      Set #{ZoneName}_Numerator = #{ZoneName}_OAFlow * #{ZoneName}_Temp_Numerator,
      Set #{ZoneName}_Denominator = 283.15 - 0.27778 - (#{ZoneName}_TZone + 273.15),
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator) + #{ZoneName}_OAFlow,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_80Flow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ELSEIF #{ZoneName}_AirFlowRate > #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      ELSEIF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    ! If we can economize, set OA flow and fan total flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef

##def VariableAhuControlOneCFMPerft2[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_ZoneFlowSizingIntervention,
  EndofZoneSizing,
  #{ZoneName}_ZoneFlowSizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SysFlowSizingIntervention,
  EndofSystemSizing,
  #{ZoneName}_SysFlowSizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
!EnergyManagementSystem:Actuator,
!  #{ZoneName}_Fan_RatedVDot, 
!  #{SystemName}_Fan,
!  Fan,
!  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TSupply,
  #{SystemName} Supply Equipment Outlet Node,
  System Node Temp;
  
!** Original Schedules
  
Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Area,
  #{ZoneName},
  Zone Floor Area;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_ZoneFanFlowRateOverride, 
  #{ZoneName},
  Sizing:Zone,
  Zone Design Cooling Vol Flow;

EnergyManagementSystem:Actuator,
  #{ZoneName}_SysFanFlowRateOverride, 
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:Program,
  #{ZoneName}_ZoneFlowSizingIntervention,
  Set #{ZoneName}_ZoneFanFlowRateOverride = #{ZoneName}_Area * 0.00508;

EnergyManagementSystem:Program,
  #{ZoneName}_SysFlowSizingIntervention,
  Set #{ZoneName}_SysFanFlowRateOverride = #{ZoneName}_Area * 0.00508;
  
EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_Area * 100.95, ! Set cooling capacity equal to 375 ft^2/ton (gross)
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_Area * 0.00508;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285 * #{ZoneName}_wb) + (0.0013562 * (#{ZoneName}_wb^2)),
  SET Part4 = (0.009934 * #{ZoneName}_OA_db) + (0.0006398 * (#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690 * #{ZoneName}_wb * #{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode, 
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    ! The following section of code is used to predict T_supply_air. The equation used is of the following form:
    !                (T_outdoor_air * Vdot_outdoor_air) + (T_return_air * Vdot_return_air) 
    !T_supply_air =  --------------------------------------------------------------------- + DeltaT_across_fan [assumed to be 0.5 F]
    !                                 (Vdot_outdoor_air + Vdot_return_air)
    Set #{ZoneName}_TSupplyPredict1 = #{ZoneName}_OAFlow * #{ZoneName}_OA_db,
    Set #{ZoneName}_TSupplyPredict2 = #{ZoneName}_AirFlowRate - #{ZoneName}_OAFlow,
    Set #{ZoneName}_TSupplyPredict3 = #{ZoneName}_TSupplyPredict2 * #{ZoneName}_TZone,
    Set #{ZoneName}_TSupplyPredict4 = #{ZoneName}_TSupplyPredict1 + #{ZoneName}_TSupplyPredict3,
    Set #{ZoneName}_TSupplyPredict5 = #{ZoneName}_TSupplyPredict4 / #{ZoneName}_AirFlowRate,
    Set #{ZoneName}_TSupplyPredict = #{ZoneName}_TSupplyPredict5 + 0.2778,
    IF #{ZoneName}_TSupplyPredict < 10.0 && #{ZoneName}_NightOperation > 0.0, ! Check to see if RTU is supplying air that is too cold (< 50 F).
      ! If the RTU is cold dumping (supplying air less than 50 F), determine the amount of SA required to ensure that the supply air
      ! temperature is 50 F (this is done by increasing the amount of return air from the zone, since the outdoor air volume flow rate is
      ! fixed at minimum while the zone is floating. The equation used to predict the requird amount of supply air is of the following form:
      !                    Vdot_outdoor_air * (T_outdoor_air - T_supply_air [set to 50 F in this case] - DeltaT_across_fan [assumed to be 0.5 F])
      ! Vdot_supply air =  ---------------------------------------------------------------------------------------------------------------------- + Vdot_outdoor_air
      !                            (T_supply_air [set to 50 F in this case] + DeltaT_across_fan [assumed to be 0.5 F] - T_return_air)
      Set #{ZoneName}_Temp_Numerator = (#{ZoneName}_OA_db + 273.15) - 283.15 + 0.27778,
      Set #{ZoneName}_Numerator = #{ZoneName}_OAFlow * #{ZoneName}_Temp_Numerator,
      Set #{ZoneName}_Denominator = 283.15 - 0.27778 - (#{ZoneName}_TZone + 273.15),
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator) + #{ZoneName}_OAFlow,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_MaxFanSp,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ENDIF,
      IF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0, ! Check to see if we can economize.
      ! If we can economize, set OA flow and fan total flow equal to max fan flow rate (i.e. damper 100% open).
      ! NO ACTIVE COOLING IN THIS CASE.
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    IF #{ZoneName}_OAFlow > 0.0,
      Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_db - #{ZoneName}_TSupply,
      ! If the CC was off for the previous timestep, we need to reasonably predict what the delta T across the 
      ! coil will be (since it is not valid to look at the previous timestep value, as the CC was off). If this
      ! is the case, set the assumed delta T to 10.0 C. This delta T is assumed to be reasonable (much more 
      ! reasonable than a negative value at least).
      IF #{ZoneName}_CC_PrevDelta < 0.0,
        Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_CC_PrevDeltaPrime / #{ZoneName}_AirFlowRate,
      ELSE,
        Set #{ZoneName}_CC_PrevDeltaPrime = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
      ENDIF,
      ! The following section of code is used to predict what SA flow rate is required in order to deliver
      ! SA at 55 F (12.7778 C). The equation used is of the following form:
      !                    (T_return_air * Vdot_outdoor_air) - (T_outdoor_air * Vdot_outdoor_air) + (DeltaT_across_CC_at_previous_timestep * Vdot_across_CC_at_previous_timestep)
      ! Vdot_supply air =  ------------------------------------------------------------------------------------------------------------------------------------------------------
      !                                                                     (T_return_air - T_supply_air [T_supply_air is set to 55 F in this case])
      Set #{ZoneName}_Numerator1 = (#{ZoneName}_TZone + 273.15) * #{ZoneName}_OAFlow,
      Set #{ZoneName}_Numerator2 = (#{ZoneName}_OA_db + 273.15) * #{ZoneName}_OAFlow,
      Set #{ZoneName}_Numerator3 = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_Numerator4 = #{ZoneName}_Numerator1 - #{ZoneName}_Numerator2,
      Set #{ZoneName}_Numerator = #{ZoneName}_Numerator3 + #{ZoneName}_Numerator4,
      Set #{ZoneName}_Denominator = (#{ZoneName}_TZone + 273.15) - 285.93,
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator),
      ELSE,
      	Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_db - #{ZoneName}_TSupply,
	Set #{ZoneName}_Numerator = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
	Set #{ZoneName}_Denominator = (#{ZoneName}_TZone + 273.15) - 285.93,
        Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator),
      ENDIF,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_MaxFanSp, ! Check to prevent a fan flow greater than what the fan can supply.
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ENDIF,
      IF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow, ! Check to prevent a fan flow less than the minimum required for comfort and ventilation.
	Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
      Set #{ZoneName}_CoolingPowerModifier = 0.5, ! Set the cooling coil to act as if only one compressor is running (i.e. Stage 1).
    ENDIF,
    RUN #{ZoneName}_HeatOff, ! Make sure heating is off.
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;
  
EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency
##enddef

##def BaselineAhuControlOnePtTwoCFMPerft2[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_ZoneFlowSizingIntervention,
  EndofZoneSizing,
  #{ZoneName}_ZoneFlowSizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SysFlowSizingIntervention,
  EndofSystemSizing,
  #{ZoneName}_SysFlowSizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
!EnergyManagementSystem:Actuator,
!  #{ZoneName}_Fan_RatedVDot, 
!  #{SystemName}_Fan,
!  Fan,
!  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

!** Original Schedules 

Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Area,
  #{ZoneName},
  Zone Floor Area;

EnergyManagementSystem:Actuator,
  #{ZoneName}_ZoneFanFlowRateOverride, 
  #{ZoneName},
  Sizing:Zone,
  Zone Design Cooling Vol Flow;

EnergyManagementSystem:Actuator,
  #{ZoneName}_SysFanFlowRateOverride, 
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:Program,
  #{ZoneName}_ZoneFlowSizingIntervention,
  Set #{ZoneName}_ZoneFanFlowRateOverride = #{ZoneName}_Area * 0.006096;

EnergyManagementSystem:Program,
  #{ZoneName}_SysFlowSizingIntervention,
  Set #{ZoneName}_SysFanFlowRateOverride = #{ZoneName}_Area * 0.006096;
  
EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_Area * 100.95, ! Set cooling capacity equal to 375 ft^2/ton (gross)
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_Area * 0.006096;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp * #{ZoneName}_NightOperation,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    ! If we can economize, set OA flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,   
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
   RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;
  
!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef

##def SteppedAhuControlOnePtTwoCFMPerft2[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_ZoneFlowSizingIntervention,
  EndofZoneSizing,
  #{ZoneName}_ZoneFlowSizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SysFlowSizingIntervention,
  EndofSystemSizing,
  #{ZoneName}_SysFlowSizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
!EnergyManagementSystem:Actuator,
!  #{ZoneName}_Fan_RatedVDot, 
!  #{SystemName}_Fan,
!  Fan,
!  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

!** Original schedules 

Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;
  
EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Area,
  #{ZoneName},
  Zone Floor Area;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_ZoneFanFlowRateOverride, 
  #{ZoneName},
  Sizing:Zone,
  Zone Design Cooling Vol Flow;

EnergyManagementSystem:Actuator,
  #{ZoneName}_SysFanFlowRateOverride, 
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:Program,
  #{ZoneName}_ZoneFlowSizingIntervention,
  Set #{ZoneName}_ZoneFanFlowRateOverride = #{ZoneName}_Area * 0.006096;

EnergyManagementSystem:Program,
  #{ZoneName}_SysFlowSizingIntervention,
  Set #{ZoneName}_SysFanFlowRateOverride = #{ZoneName}_Area * 0.006096;
  
EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_Area * 100.95, ! Set cooling capacity equal to 375 ft^2/ton (gross)
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_Area * 0.006096;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285*#{ZoneName}_wb) + (0.0013562*(#{ZoneName}_wb^2)),
  SET Part4 = (0.009934*#{ZoneName}_OA_db) + (0.0006398*(#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690*#{ZoneName}_wb*#{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode,
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_80Flow = 0.8 * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_80Flow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_80Flow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    ! The following section of code is used to predict T_supply_air. The equation used is of the following form:
    !                (T_outdoor_air * Vdot_outdoor_air) + (T_return_air * Vdot_return_air) 
    !T_supply_air =  --------------------------------------------------------------------- + DeltaT_across_fan [assumed to be 0.5 F]
    !                                 (Vdot_outdoor_air + Vdot_return_air)
    Set #{ZoneName}_TSupplyPredict1 = #{ZoneName}_OAFlow * #{ZoneName}_OA_db,
    Set #{ZoneName}_TSupplyPredict2 = #{ZoneName}_AirFlowRate - #{ZoneName}_OAFlow,
    Set #{ZoneName}_TSupplyPredict3 = #{ZoneName}_TSupplyPredict2 * #{ZoneName}_TZone,
    Set #{ZoneName}_TSupplyPredict4 = #{ZoneName}_TSupplyPredict1 + #{ZoneName}_TSupplyPredict3,
    Set #{ZoneName}_TSupplyPredict5 = #{ZoneName}_TSupplyPredict4 / #{ZoneName}_AirFlowRate,
    Set #{ZoneName}_TSupplyPredict = #{ZoneName}_TSupplyPredict5 + 0.2778,
    IF #{ZoneName}_TSupplyPredict < 10.0 && #{ZoneName}_NightOperation > 0.0, ! Check to see if RTU is supplying air that is too cold (< 50 F).
      ! If the RTU is cold dumping (supplying air less than 50 F), determine the amount of SA required to ensure that the supply air
      ! temperature is 50 F (this is done by increasing the amount of return air from the zone, since the outdoor air volume flow rate is
      ! fixed at minimum while the zone is floating. The equation used to predict the requird amount of supply air is of the following form:
      !                    Vdot_outdoor_air * (T_outdoor_air - T_supply_air [set to 50 F in this case] - DeltaT_across_fan [assumed to be 0.5 F])
      ! Vdot_supply air =  ---------------------------------------------------------------------------------------------------------------------- + Vdot_outdoor_air
      !                            (T_supply_air [set to 50 F in this case] + DeltaT_across_fan [assumed to be 0.5 F] - T_return_air)
      Set #{ZoneName}_Temp_Numerator = (#{ZoneName}_OA_db + 273.15) - 283.15 + 0.27778,
      Set #{ZoneName}_Numerator = #{ZoneName}_OAFlow * #{ZoneName}_Temp_Numerator,
      Set #{ZoneName}_Denominator = 283.15 - 0.27778 - (#{ZoneName}_TZone + 273.15),
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator) + #{ZoneName}_OAFlow,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_80Flow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ELSEIF #{ZoneName}_AirFlowRate > #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      ELSEIF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    ! If we can economize, set OA flow and fan total flow equal to max fan flow rate (i.e. damper 100% open).
    ! NO ACTIVE COOLING IN THIS CASE.
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_OAFlow = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_80Flow,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
      Set #{ZoneName}_CoolingPowerModifier = 0.5,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,    
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;

EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency

##enddef

##def VariableAhuControlOnePtTwoCFMPerft2[]

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program1,
  AfterPredictorAfterHVACManagers,
  #{ZoneName}_Main;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SATManager_Program2,
  InsideHVACSystemIterationLoop,
  #{ZoneName}_SetCoolingPower;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SizingIntervention,
  AfterComponentInputReadIn,
  #{ZoneName}_SizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_ZoneFlowSizingIntervention,
  EndofZoneSizing,
  #{ZoneName}_ZoneFlowSizingIntervention;

EnergyManagementSystem:ProgramCallingManager,
  #{ZoneName}_SysFlowSizingIntervention,
  EndofSystemSizing,
  #{ZoneName}_SysFlowSizingIntervention;

EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_CoolingPowerModifier;
  
EnergyManagementSystem:GlobalVariable,
  #{ZoneName}_mode;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HVACOperationSchd,
  HVACOperationSchd,
  Schedule:Compact,
  Schedule Value;

EnergyManagementSystem:Actuator,
  #{ZoneName}_AirFlowRate,
  #{ZoneName} DIRECT AIR,
  AirTerminal:SingleDuct:Uncontrolled,
  Mass Flow Rate;
  
EnergyManagementSystem:GlobalVariable,
  G_#{ZoneName}_AirFlowRate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FT_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncTempCurve,
  Curve,
  Curve Result;
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CC_FF_Curve,
  #{SystemName}_CoolC 1_ClgCapFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FT_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncTempCurve,
  Curve,
  Curve Result;   
    
EnergyManagementSystem:Actuator,
  #{ZoneName}_CE_FF_Curve,
  #{SystemName}_CoolC 1_ClgEirFuncFlowFracCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_PLR_Curve,
  #{SystemName}_CoolC 1_ClgPlrCurve,
  Curve,
  Curve Result;

EnergyManagementSystem:Actuator,
  #{ZoneName}_CoolSetpoint,
  #{SystemName}_CoolC 1-#{SystemName}_HeatC 1Node,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_HeatSetpoint,
  #{SystemName}_HeatC 1-#{SystemName}_FanNode,
  System Node Setpoint,
  Temperature Setpoint;

EnergyManagementSystem:Actuator,
  #{ZoneName}_OAFlow,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller,
  Air Mass Flow Rate;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedSHR, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Sensible Heat Ratio;

EnergyManagementSystem:Actuator,
  #{ZoneName}_RatedTotCap, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Total Cooling Capacity;

EnergyManagementSystem:Actuator,
  #{ZoneName}_DXCoil_RatedVdot, 
  #{SystemName}_CoolC 1 DXCoil,
  Coil:Cooling:DX:SingleSpeed,
  Autosized Rated Air Flow Rate;
  
!EnergyManagementSystem:Actuator,
!  #{ZoneName}_Fan_RatedVDot, 
!  #{SystemName}_Fan,
!  Fan,
!  Fan Autosized Air Flow Rate;  

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Fan_RatedMaximumFlow,
  #{SystemName}_Fan,
  Fan Maximum Mass Flow Rate;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TZone,
  #{ZoneName} Air Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_hr,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Humidity Ratio;

EnergyManagementSystem:Sensor,
  #{ZoneName}_db,
  #{SystemName}_OA-#{SystemName}_CoolC 1Node,
  System Node Temp;

EnergyManagementSystem:Sensor,
  #{ZoneName}_OA_db,
  ,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{ZoneName}_atm,
  ,
  Outdoor Barometric Pressure;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TSupply,
  #{SystemName} Supply Equipment Outlet Node,
  System Node Temp;
  
!** Original Schedules
  
Schedule:Compact,
  #{ZoneName}_THeatSP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 15.000, ! 59.0F
  Until: 23:00, 20.000, ! 68.0F
  Until: 24:00, 15.000; ! 59.0F

Schedule:Compact,
  #{ZoneName}_THeat1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 14.444, ! 58.0F
  Until: 23:00, 19.444, ! 67.0F
  Until: 24:00, 14.444; ! 58.0F

Schedule:Compact,
  #{ZoneName}_TCool1SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.222, ! 81.0F
  Until: 23:00, 23.333, ! 74.0F
  Until: 24:00, 27.222; ! 81.0F

Schedule:Compact,
  #{ZoneName}_TCool2SP_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 27.778, ! 82.0F
  Until: 23:00, 23.889, ! 75.0F
  Until: 24:00, 27.778; ! 82.0F

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeatSP,
  #{ZoneName}_THeatSP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_THeat1SP,
  #{ZoneName}_THeat1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool1SP,
  #{ZoneName}_TCool1SP_Sch,
  Schedule Value;

EnergyManagementSystem:Sensor,
  #{ZoneName}_TCool2SP,
  #{ZoneName}_TCool2SP_Sch,
  Schedule Value;

Schedule:Compact,
  #{ZoneName}_NightOperation_Sch,
  Temperature,
  Through: 12/31,
  For: AllDays,
  Until: 07:00, 0.0,
  Until: 23:00, 1.0,
  Until: 24:00, 0.0;

EnergyManagementSystem:Sensor,
  #{ZoneName}_NightOperation,
  #{ZoneName}_NightOperation_Sch,
  Schedule Value;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_DesignVentilationFanSpeed,
  #{SystemName}_OA_CONTROLLER,
  Outdoor Air Controller Minimum Mass Flow Rate;

EnergyManagementSystem:InternalVariable,
  #{ZoneName}_Area,
  #{ZoneName},
  Zone Floor Area;
  
EnergyManagementSystem:Actuator,
  #{ZoneName}_ZoneFanFlowRateOverride, 
  #{ZoneName},
  Sizing:Zone,
  Zone Design Cooling Vol Flow;

EnergyManagementSystem:Actuator,
  #{ZoneName}_SysFanFlowRateOverride, 
  #{SystemName},
  Sizing:System,
  Main Supply Volume Flow Rate;

EnergyManagementSystem:Program,
  #{ZoneName}_ZoneFlowSizingIntervention,
  Set #{ZoneName}_ZoneFanFlowRateOverride = #{ZoneName}_Area * 0.006096;

EnergyManagementSystem:Program,
  #{ZoneName}_SysFlowSizingIntervention,
  Set #{ZoneName}_SysFanFlowRateOverride = #{ZoneName}_Area * 0.006096;
  
EnergyManagementSystem:Program,
  #{ZoneName}_SizingIntervention,
  Set #{ZoneName}_RatedSHR = 0.7,
  Set #{ZoneName}_RatedTotCap = #{ZoneName}_Area * 100.95, ! Set cooling capacity equal to 375 ft^2/ton (gross)
  Set #{ZoneName}_DXCoil_RatedVdot = #{ZoneName}_Area * 0.006096;

EnergyManagementSystem:Program,
  #{ZoneName}_SetCoolingPower,
  SET #{ZoneName}_wb = @TwbFnTdbWPb #{ZoneName}_db #{ZoneName}_hr #{ZoneName}_atm,
  SET #{ZoneName}_ff = G_#{ZoneName}_AirFlowRate / #{ZoneName}_Fan_RatedMaximumFlow,
  IF #{ZoneName}_wb < 11.1, ! Set min and max limits for the coil entering wb, as per the preprocessor.
    SET #{ZoneName}_wb = 11.1,
  ELSEIF #{ZoneName}_wb > 29.4,
    SET #{ZoneName}_wb = 29.4,
  ENDIF,
  IF #{ZoneName}_OA_db < 10.0, ! Set min and max limits for air cooled condenser entering db, as per the preprocessor.
    SET #{ZoneName}_OA_db = 10.0,
  ELSEIF #{ZoneName}_OA_db > 50.3,
    SET #{ZoneName}_OA_db = 50.3,
  ENDIF,
  IF #{ZoneName}_ff < 0.776, ! Set min and max limits for the flow fraction, as per the preprocessor.
    SET #{ZoneName}_ff = 0.776,
  ELSEIF #{ZoneName}_ff > 1.197,
    SET #{ZoneName}_ff = 1.197,
  ENDIF,
  SET Part1 = 0.52357 + (0.03478 * #{ZoneName}_wb) + (0 * (#{ZoneName}_wb^2)),
  SET Part2 = (0.001915 * #{ZoneName}_OA_db) + (0.00010838 * (#{ZoneName}_OA_db^2)), 
  SET #{ZoneName}_CC_FT_Curve = Part1 - Part2,
  SET #{ZoneName}_CC_FF_Curve = 0.7685 + (0.2315 * #{ZoneName}_ff) + (0 * (#{ZoneName}_ff^2)), 
  SET #{ZoneName}_CC_FF_Curve = #{ZoneName}_CC_FF_Curve * #{ZoneName}_CoolingPowerModifier, 
  SET Part3 = 0.9847 - (0.04285 * #{ZoneName}_wb) + (0.0013562 * (#{ZoneName}_wb^2)),
  SET Part4 = (0.009934 * #{ZoneName}_OA_db) + (0.0006398 * (#{ZoneName}_OA_db^2)),
  SET Part5 = (0.0011690 * #{ZoneName}_wb * #{ZoneName}_OA_db),
  SET #{ZoneName}_CE_FT_Curve = Part3 + Part4 - Part5,
  SET #{ZoneName}_CE_FF_Curve = 1.192 - (0.1917 * #{ZoneName}_ff),
  SET #{ZoneName}_PLR_Curve = 1.0; 
  
EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOn,
  Set #{ZoneName}_HeatSetpoint = 100.0;

EnergyManagementSystem:Subroutine,
  #{ZoneName}_HeatOff,
  Set #{ZoneName}_HeatSetpoint = (0-50.0);

!-Actuates on the mode setting chosen in Main program
EnergyManagementSystem:Subroutine,
  #{ZoneName}_RunMode, 
  IF #{ZoneName}_Fan_RatedMaximumFlow > #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_Fan_RatedMaximumFlow,
  ELSE,
    Set #{ZoneName}_MaxFanSp = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  Set #{ZoneName}_TurnDown = #{EMSTurnDownRatio},
  Set #{ZoneName}_MinFlow = #{ZoneName}_TurnDown * #{ZoneName}_MaxFanSp,
  IF #{ZoneName}_MinFlow < #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_MinFlow = #{ZoneName}_DesignVentilationFanSpeed,
  ENDIF,
  IF #{ZoneName}_mode == 0.0, ! Check to see if we are commanding floating
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow * #{ZoneName}_NightOperation,
    ! The following section of code is used to predict T_supply_air. The equation used is of the following form:
    !                (T_outdoor_air * Vdot_outdoor_air) + (T_return_air * Vdot_return_air) 
    !T_supply_air =  --------------------------------------------------------------------- + DeltaT_across_fan [assumed to be 0.5 F]
    !                                 (Vdot_outdoor_air + Vdot_return_air)
    Set #{ZoneName}_TSupplyPredict1 = #{ZoneName}_OAFlow * #{ZoneName}_OA_db,
    Set #{ZoneName}_TSupplyPredict2 = #{ZoneName}_AirFlowRate - #{ZoneName}_OAFlow,
    Set #{ZoneName}_TSupplyPredict3 = #{ZoneName}_TSupplyPredict2 * #{ZoneName}_TZone,
    Set #{ZoneName}_TSupplyPredict4 = #{ZoneName}_TSupplyPredict1 + #{ZoneName}_TSupplyPredict3,
    Set #{ZoneName}_TSupplyPredict5 = #{ZoneName}_TSupplyPredict4 / #{ZoneName}_AirFlowRate,
    Set #{ZoneName}_TSupplyPredict = #{ZoneName}_TSupplyPredict5 + 0.2778,
    IF #{ZoneName}_TSupplyPredict < 10.0 && #{ZoneName}_NightOperation > 0.0, ! Check to see if RTU is supplying air that is too cold (< 50 F).
      ! If the RTU is cold dumping (supplying air less than 50 F), determine the amount of SA required to ensure that the supply air
      ! temperature is 50 F (this is done by increasing the amount of return air from the zone, since the outdoor air volume flow rate is
      ! fixed at minimum while the zone is floating. The equation used to predict the requird amount of supply air is of the following form:
      !                    Vdot_outdoor_air * (T_outdoor_air - T_supply_air [set to 50 F in this case] - DeltaT_across_fan [assumed to be 0.5 F])
      ! Vdot_supply air =  ---------------------------------------------------------------------------------------------------------------------- + Vdot_outdoor_air
      !                            (T_supply_air [set to 50 F in this case] + DeltaT_across_fan [assumed to be 0.5 F] - T_return_air)
      Set #{ZoneName}_Temp_Numerator = (#{ZoneName}_OA_db + 273.15) - 283.15 + 0.27778,
      Set #{ZoneName}_Numerator = #{ZoneName}_OAFlow * #{ZoneName}_Temp_Numerator,
      Set #{ZoneName}_Denominator = 283.15 - 0.27778 - (#{ZoneName}_TZone + 273.15),
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator) + #{ZoneName}_OAFlow,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_MaxFanSp,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ENDIF,
      IF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow,
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ELSEIF #{ZoneName}_mode == 1.0, ! Check to see if we are commanding Stage 1 cooling
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0, ! Check to see if we can economize.
      ! If we can economize, set OA flow and fan total flow equal to max fan flow rate (i.e. damper 100% open).
      ! NO ACTIVE COOLING IN THIS CASE.
      Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      Set #{ZoneName}_OAFlow = #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_CoolingPowerModifier = 0.00001,
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    IF #{ZoneName}_OAFlow > 0.0,
      Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_db - #{ZoneName}_TSupply,
      ! If the CC was off for the previous timestep, we need to reasonably predict what the delta T across the 
      ! coil will be (since it is not valid to look at the previous timestep value, as the CC was off). If this
      ! is the case, set the assumed delta T to 10.0 C. This delta T is assumed to be reasonable (much more 
      ! reasonable than a negative value at least).
      IF #{ZoneName}_CC_PrevDelta < 0.0,
        Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_CC_PrevDeltaPrime / #{ZoneName}_AirFlowRate,
      ELSE,
        Set #{ZoneName}_CC_PrevDeltaPrime = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
      ENDIF,
      ! The following section of code is used to predict what SA flow rate is required in order to deliver
      ! SA at 55 F (12.7778 C). The equation used is of the following form:
      !                    (T_return_air * Vdot_outdoor_air) - (T_outdoor_air * Vdot_outdoor_air) + (DeltaT_across_CC_at_previous_timestep * Vdot_across_CC_at_previous_timestep)
      ! Vdot_supply air =  ------------------------------------------------------------------------------------------------------------------------------------------------------
      !                                                                     (T_return_air - T_supply_air [T_supply_air is set to 55 F in this case])
      Set #{ZoneName}_Numerator1 = (#{ZoneName}_TZone + 273.15) * #{ZoneName}_OAFlow,
      Set #{ZoneName}_Numerator2 = (#{ZoneName}_OA_db + 273.15) * #{ZoneName}_OAFlow,
      Set #{ZoneName}_Numerator3 = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
      Set #{ZoneName}_Numerator4 = #{ZoneName}_Numerator1 - #{ZoneName}_Numerator2,
      Set #{ZoneName}_Numerator = #{ZoneName}_Numerator3 + #{ZoneName}_Numerator4,
      Set #{ZoneName}_Denominator = (#{ZoneName}_TZone + 273.15) - 285.93,
      Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator),
      ELSE,
      	Set #{ZoneName}_CC_PrevDelta = #{ZoneName}_db - #{ZoneName}_TSupply,
	Set #{ZoneName}_Numerator = #{ZoneName}_CC_PrevDelta * #{ZoneName}_AirFlowRate,
	Set #{ZoneName}_Denominator = (#{ZoneName}_TZone + 273.15) - 285.93,
        Set #{ZoneName}_AirFlowRate = (#{ZoneName}_Numerator / #{ZoneName}_Denominator),
      ENDIF,
      IF #{ZoneName}_AirFlowRate > #{ZoneName}_MaxFanSp, ! Check to prevent a fan flow greater than what the fan can supply.
        Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
      ENDIF,
      IF #{ZoneName}_AirFlowRate < #{ZoneName}_MinFlow, ! Check to prevent a fan flow less than the minimum required for comfort and ventilation.
	Set #{ZoneName}_AirFlowRate = #{ZoneName}_MinFlow,
      ENDIF,
      Set #{ZoneName}_CoolingPowerModifier = 0.5, ! Set the cooling coil to act as if only one compressor is running (i.e. Stage 1).
    ENDIF,
    RUN #{ZoneName}_HeatOff, ! Make sure heating is off.
  ELSEIF #{ZoneName}_mode == 2.0, ! Check to see if we are commanding Stage 2 cooling
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    IF #{ZoneName}_OA_db < 18.3333 && #{ZoneName}_OA_db > 10.0,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed,    
    ELSE,
      Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    ENDIF,
    RUN #{ZoneName}_HeatOff,
    Set #{ZoneName}_CoolingPowerModifier = 1.0,
  ELSEIF #{ZoneName}_mode == 3.0, ! Heating mode
    Set #{ZoneName}_OAFlow = #{ZoneName}_DesignVentilationFanSpeed * #{ZoneName}_NightOperation,
    Set #{ZoneName}_AirFlowRate = #{ZoneName}_MaxFanSp,
    RUN #{ZoneName}_HeatOn,
    Set #{ZoneName}_CoolingPowerModifier = 0.00001,
  ENDIF,
  Set G_#{ZoneName}_AirFlowRate = #{ZoneName}_AirFlowRate;
  
EnergyManagementSystem:Program,
  #{ZoneName}_Main,
  Set #{ZoneName}_OAFlow = NULL,
  Set #{ZoneName}_CoolSetpoint = 0.0,
  Set #{ZoneName}_HVACOperationSchd = 1.0,
  Set #{ZoneName}_maxheatpoint = #{ZoneName}_THeatSP + 0.555556, 
  Set #{ZoneName}_maxcoolpoint = #{ZoneName}_TCool1SP - 0.555556,
  ! The modeLock is used to hold the current mode until zone temps hit the middle of the deadband
  Set #{ZoneName}_modeLock = 0.0,
  IF #{ZoneName}_mode == 3.0,
    IF #{ZoneName}_TZone < #{ZoneName}_maxheatpoint, 
      Set #{ZoneName}_mode = 3.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 2.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint, 
      Set #{ZoneName}_mode = 2.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
  ELSEIF #{ZoneName}_mode == 1.0,
    IF #{ZoneName}_TZone > #{ZoneName}_maxcoolpoint,
    IF #{ZoneName}_TZone < #{ZoneName}_TCool2SP, 
      Set #{ZoneName}_mode = 1.0,
      Set #{ZoneName}_modeLock = 1.0,
    ENDIF,
    ENDIF,
  ENDIF,
  ! If no modeLock, operate the coils purely based on the heating and cooling setpoints
  IF #{ZoneName}_modeLock == 0.0,
    IF #{ZoneName}_TZone < #{ZoneName}_THeatSP,
      Set #{ZoneName}_mode = 3.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool2SP,
      Set #{ZoneName}_mode = 2.0,
    ELSEIF #{ZoneName}_TZone > #{ZoneName}_TCool1SP, 
      Set #{ZoneName}_mode = 1.0,
    ELSE,
      Set #{ZoneName}_mode = 0.0,
    ENDIF,
  ENDIF,
  RUN #{ZoneName}_RunMode;

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_CoolingPowerModifier, ! Name
!#{ZoneName}_CoolingPowerModifier, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep ; ! Update Frequency

!EnergyManagementSystem:OutputVariable,
!#{ZoneName}_Mode, ! Name
!#{ZoneName}_mode, ! EMS Variable Name
!Averaged, ! Type of Data in Variable
!SystemTimeStep; ! Update Frequency
##enddef

##def VAV_SAT_Reset_Retail_AEDG[]

!- VAV SAT Econ Reset

!- Sensors

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_OA_Enth,
  Environment,
  Outdoor Enthalpy;

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_OA_Tdb,
  Environment,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_Pb,
  Environment,
  Outdoor Barometric Pressure;

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_RA_Enth,
  #{SystemName} Supply Equipment Inlet Node,
  System Node Enthalpy;
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_Heat_Load,
  #{ZoneName},
  Zone/Sys Sensible Load to Heating Setpoint Predicted;  
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_FanFraction,
  #{ZoneName} VAV Box Component,
  VAV Terminal Damper Position;
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_MinFlowFraction,
  #{ZoneName} VAV Box Component,
  VAV Terminal Minimum Air Flow Fraction;  
  
EnergyManagementSystem:Sensor,
  #{CleanZoneName}_RH,
  #{ZoneName},
  Zone Air Relative Humidity;  
  
EnergyManagementSystem:Sensor,
  #{CleanZoneName}_Tdb,
  #{ZoneName},
  Zone/Sys Air Temperature;    
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_ClgSetP,
  ClgSetP_Sch,
  Schedule Value;      
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_SAT,
  VAV_SAT_Schedule,
  Schedule Value;    

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_SAT_Econ,
  VAV_Econ_SAT_Schedule,
  Schedule Value;    

!- Trend Variables

EnergyManagementSystem:TrendVariable,
  #{CleanSystemName}_FanFractionLog,
  #{CleanSystemName}_FanFraction,
  4;  

!- Global Variables

EnergyManagementSystem:GlobalVariable,
#{CleanSystemName}_SAT_Value;

!- Actuators

EnergyManagementSystem:Actuator,
  #{CleanSystemName}_SAT_Sch_Act, 
  #{SystemName}_SAT_Sch,
  Schedule:Compact,
  Schedule Value;
  
EnergyManagementSystem:Actuator,  
  #{CleanSystemName}_Fan_Sch_Act, 
  #{SystemName}_Fan_Sch,
  Schedule:Compact,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,  
  #{CleanZoneName}_PTAC_Fan_Sch_Act, 
  #{ZoneName}_PTAC_Fan_Sch,
  Schedule:Compact,
  Schedule Value;    
  
!- Calling Managers

EnergyManagementSystem:ProgramCallingManager,  
  #{CleanSystemName}_Initialize_Globals_Call,
  BeginNewEnvironment,
  #{CleanSystemName}_Initialize_Globals;

EnergyManagementSystem:ProgramCallingManager,
  #{CleanSystemName}_SAT_Reset_Call,
  AfterPredictorBeforeHVACManagers,
  #{CleanSystemName}_SAT_Reset;  
  
!- Programs

EnergyManagementSystem:Program,
  #{CleanSystemName}_Initialize_Globals,
  
SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT;   

EnergyManagementSystem:Program,
  #{CleanSystemName}_SAT_Reset,
  
!- Check for heating mode
IF #{CleanSystemName}_Heat_Load > 0,
    !- System is in heating mode; turn off VAV and turn on PTAC
    SET #{CleanSystemName}_Fan_Sch_Act = 0,
    SET #{CleanZoneName}_PTAC_Fan_Sch_Act = 1,
ELSE,
    !- Not in heating mode; turn on VAV and turn off PTAC
    SET #{CleanSystemName}_Fan_Sch_Act = 1,
    SET #{CleanZoneName}_PTAC_Fan_Sch_Act = 0,
    !- Check for extended economizing conditions
    IF (#{CleanSystemName}_OA_Tdb > #{CleanSystemName}_SAT_Value),
        IF #{CleanSystemName}_OA_Enth < #{CleanSystemName}_RA_Enth,
            !- Economizing Conditions
            SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Econ,
            SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT_Econ,
        ENDIF,
    ELSE,
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
    ENDIF,
    !- Check for low load case; min flow stop indicates low load 
    IF (@TrendSum #{CleanSystemName}_FanFractionLog 3)<3*(#{CleanSystemName}_MinFlowFraction + 0.01),
        !- Low load case; incrase SAT 5 F as per 90.1-2010
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT + 2.78,
        SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT + 2.78,
    ELSE,
        !- Not low load case
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
    ENDIF,    
    !- Check if near top of deadband
    IF #{CleanZoneName}_Tdb > (#{CleanSystemName}_ClgSetP - 1.0),
        !- Near cooling setpoint; revert to original SAT
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT,
        SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT,
    ELSE,
        !- Not near cooling setpoint
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
    ENDIF,
ENDIF,

!- Humidity check
!- Determine dewpoint at 75 F, 60% RH

SET #{CleanSystemName}_W = @WFnTdbRhPb 23.89 0.6 #{CleanSystemName}_Pb,
SET #{CleanSystemName}_Tdp = @TdpFnWPb #{CleanSystemName}_W #{CleanSystemName}_Pb,

!- Compare zone conditions to threshold value

SET #{CleanZoneName}_W = @WFnTdbRhPb #{CleanZoneName}_Tdb #{CleanZoneName}_RH/100 #{CleanSystemName}_Pb,
SET #{CleanZoneName}_Tdp = @TdpFnWPb #{CleanZoneName}_W #{CleanSystemName}_Pb,

IF #{CleanZoneName}_Tdp > #{CleanSystemName}_Tdp,
    !- High humidity case; set SAT to default
    SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT,
    SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT,
ELSE,
    !- Not high humidity
    SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
ENDIF;    
    
##enddef


##def ERV_IDEC_Retail_AEDG[]

!- ERV IDEC

!- Sensors

EnergyManagementSystem:Sensor,
    #{CleanSystemName}_Warm_Season,             !- Name
    Warm_Season_Sch,        !- Output:Variable or Output:Meter Index Key Name
    Schedule Value;  !- Output:Variable or Output:Meter Name                
  
EnergyManagementSystem:Sensor,
    #{CleanSystemName}_Cold_Season,             !- Name
    Cold_Season_Sch,        !- Output:Variable or Output:Meter Index Key Name
    Schedule Value;  !- Output:Variable or Output:Meter Name  
  
!- Internal Variables

EnergyManagementSystem:InternalVariable,
    #{CleanSystemName}_FanSP,           !- Name
    #{SystemName}_Fan,        !- Internal Data Index Key Name
    Fan Nominal Pressure Rise;  !- Internal Data Type  
    
!- Actuators

EnergyManagementSystem:Actuator,
    #{CleanSystemName}_FanSP_Act,  !- Name
    #{SystemName}_Fan,                   !- Actuated Component Unique Name
    Fan,             !- Actuated Component Type
    Fan Pressure Rise;     !- Actuated Component Control Type                               

!- Calling Manager      

EnergyManagementSystem:ProgramCallingManager,
    #{CleanSystemName}_ERV_IDEC_Control_Call,       !- Name
    AfterPredictorBeforeHVACManagers,  !- EnergyPlus Model Calling Point
    #{CleanSystemName}_ERV_IDEC_Control;   !- Program Name 1            
    
!- Program

EnergyManagementSystem:Program,
    #{CleanSystemName}_ERV_IDEC_Control, !- Name
    SET #{CleanSystemName}_ERV_SP = #{CleanSystemName}_Cold_Season * 253,
    SET #{CleanSystemName}_IDEC_SP = #{CleanSystemName}_Warm_Season * 295,
    SET #{CleanSystemName}_FanSP_Act = #{CleanSystemName}_FanSP + #{CleanSystemName}_ERV_SP,
    SET #{CleanSystemName}_FanSP_Act = #{CleanSystemName}_FanSP_Act + #{CleanSystemName}_IDEC_SP;
    
##enddef    

##def VAV_SAT_Reset_ERV_IDEC_Retail_AEDG[]

!- ERV IDEC

!- Sensors

EnergyManagementSystem:Sensor,
    #{CleanSystemName}_Warm_Season,             !- Name
    Warm_Season_Sch,        !- Output:Variable or Output:Meter Index Key Name
    Schedule Value;  !- Output:Variable or Output:Meter Name                
  
EnergyManagementSystem:Sensor,
    #{CleanSystemName}_Cold_Season,             !- Name
    Cold_Season_Sch,        !- Output:Variable or Output:Meter Index Key Name
    Schedule Value;  !- Output:Variable or Output:Meter Name  
  
!- Internal Variables

EnergyManagementSystem:InternalVariable,
    #{CleanSystemName}_FanSP,           !- Name
    #{SystemName}_Fan,        !- Internal Data Index Key Name
    Fan Nominal Pressure Rise;  !- Internal Data Type  
    
!- Actuators

EnergyManagementSystem:Actuator,
    #{CleanSystemName}_FanSP_Act,  !- Name
    #{SystemName}_Fan,                   !- Actuated Component Unique Name
    Fan,             !- Actuated Component Type
    Fan Pressure Rise;     !- Actuated Component Control Type                               

!- Calling Manager      

EnergyManagementSystem:ProgramCallingManager,
    #{CleanSystemName}_ERV_IDEC_Control_Call,       !- Name
    AfterPredictorBeforeHVACManagers,  !- EnergyPlus Model Calling Point
    #{CleanSystemName}_ERV_IDEC_Control;   !- Program Name 1            
    
!- Program

EnergyManagementSystem:Program,
    #{CleanSystemName}_ERV_IDEC_Control, !- Name
    SET #{CleanSystemName}_ERV_SP = #{CleanSystemName}_Cold_Season * 253,
    SET #{CleanSystemName}_IDEC_SP = #{CleanSystemName}_Warm_Season * 295,
    SET #{CleanSystemName}_FanSP_Act = #{CleanSystemName}_FanSP + #{CleanSystemName}_ERV_SP,
    SET #{CleanSystemName}_FanSP_Act = #{CleanSystemName}_FanSP_Act + #{CleanSystemName}_IDEC_SP;
    
!- VAV SAT Econ Reset

!- Sensors

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_OA_Enth,
  Environment,
  Outdoor Enthalpy;

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_OA_Tdb,
  Environment,
  Outdoor Dry Bulb;

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_Pb,
  Environment,
  Outdoor Barometric Pressure;

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_RA_Enth,
  #{SystemName} Supply Equipment Inlet Node,
  System Node Enthalpy;
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_Heat_Load,
  #{ZoneName},
  Zone/Sys Sensible Load to Heating Setpoint Predicted;  
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_FanFraction,
  #{ZoneName} VAV Box Component,
  VAV Terminal Damper Position;
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_MinFlowFraction,
  #{ZoneName} VAV Box Component,
  VAV Terminal Minimum Air Flow Fraction;  
  
EnergyManagementSystem:Sensor,
  #{CleanZoneName}_RH,
  #{ZoneName},
  Zone Air Relative Humidity;  
  
EnergyManagementSystem:Sensor,
  #{CleanZoneName}_Tdb,
  #{ZoneName},
  Zone/Sys Air Temperature;    
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_ClgSetP,
  ClgSetP_Sch,
  Schedule Value;      
  
EnergyManagementSystem:Sensor,
  #{CleanSystemName}_SAT,
  VAV_SAT_Schedule,
  Schedule Value;    

EnergyManagementSystem:Sensor,
  #{CleanSystemName}_SAT_Econ,
  VAV_Econ_SAT_Schedule,
  Schedule Value;    

!- Trend Variables

EnergyManagementSystem:TrendVariable,
  #{CleanSystemName}_FanFractionLog,
  #{CleanSystemName}_FanFraction,
  4;  

!- Global Variables

EnergyManagementSystem:GlobalVariable,
#{CleanSystemName}_SAT_Value;

!- Actuators

EnergyManagementSystem:Actuator,
  #{CleanSystemName}_SAT_Sch_Act, 
  #{SystemName}_SAT_Sch,
  Schedule:Compact,
  Schedule Value;
  
EnergyManagementSystem:Actuator,  
  #{CleanSystemName}_Fan_Sch_Act, 
  #{SystemName}_Fan_Sch,
  Schedule:Compact,
  Schedule Value;  
  
EnergyManagementSystem:Actuator,  
  #{CleanZoneName}_PTAC_Fan_Sch_Act, 
  #{ZoneName}_PTAC_Fan_Sch,
  Schedule:Compact,
  Schedule Value;    
  
!- Calling Managers

EnergyManagementSystem:ProgramCallingManager,  
  #{CleanSystemName}_Initialize_Globals_Call,
  BeginNewEnvironment,
  #{CleanSystemName}_Initialize_Globals;

EnergyManagementSystem:ProgramCallingManager,
  #{CleanSystemName}_SAT_Reset_Call,
  AfterPredictorBeforeHVACManagers,
  #{CleanSystemName}_SAT_Reset;  
  
!- Programs

EnergyManagementSystem:Program,
  #{CleanSystemName}_Initialize_Globals,
  
SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT;   

EnergyManagementSystem:Program,
  #{CleanSystemName}_SAT_Reset,
  
!- Check for heating mode
IF #{CleanSystemName}_Heat_Load > 0,
    !- System is in heating mode; turn off VAV and turn on PTAC
    SET #{CleanSystemName}_Fan_Sch_Act = 0,
    SET #{CleanZoneName}_PTAC_Fan_Sch_Act = 1,
ELSE,
    !- Not in heating mode; turn on VAV and turn off PTAC
    SET #{CleanSystemName}_Fan_Sch_Act = 1,
    SET #{CleanZoneName}_PTAC_Fan_Sch_Act = 0,
    !- Check for extended economizing conditions
    IF (#{CleanSystemName}_OA_Tdb > #{CleanSystemName}_SAT_Value),
        IF #{CleanSystemName}_OA_Enth < #{CleanSystemName}_RA_Enth,
            !- Economizing Conditions
            SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Econ,
            SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT_Econ,
        ENDIF,
    ELSE,
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
    ENDIF,
    !- Check for low load case; min flow stop indicates low load 
    IF (@TrendSum #{CleanSystemName}_FanFractionLog 3)<3*(#{CleanSystemName}_MinFlowFraction + 0.01),
        !- Low load case; incrase SAT 5 F as per 90.1-2010
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT + 2.78,
        SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT + 2.78,
    ELSE,
        !- Not low load case
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
    ENDIF,    
    !- Check if near top of deadband
    IF #{CleanZoneName}_Tdb > (#{CleanSystemName}_ClgSetP - 1.0),
        !- Near cooling setpoint; revert to original SAT
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT,
        SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT,
    ELSE,
        !- Not near cooling setpoint
        SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
    ENDIF,
ENDIF,

!- Humidity check
!- Determine dewpoint at 75 F, 60% RH

SET #{CleanSystemName}_W = @WFnTdbRhPb 23.89 0.6 #{CleanSystemName}_Pb,
SET #{CleanSystemName}_Tdp = @TdpFnWPb #{CleanSystemName}_W #{CleanSystemName}_Pb,

!- Compare zone conditions to threshold value

SET #{CleanZoneName}_W = @WFnTdbRhPb #{CleanZoneName}_Tdb #{CleanZoneName}_RH/100 #{CleanSystemName}_Pb,
SET #{CleanZoneName}_Tdp = @TdpFnWPb #{CleanZoneName}_W #{CleanSystemName}_Pb,

IF #{CleanZoneName}_Tdp > #{CleanSystemName}_Tdp,
    !- High humidity case; set SAT to default
    SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT,
    SET #{CleanSystemName}_SAT_Value = #{CleanSystemName}_SAT,
ELSE,
    !- Not high humidity
    SET #{CleanSystemName}_SAT_Sch_Act = #{CleanSystemName}_SAT_Value,
ENDIF;    
    
##enddef

##def ERV_IDEC_Retail_DualDuct_AEDG[]

!- ERV IDEC

!- Sensors

EnergyManagementSystem:Sensor,
    #{CleanSystemName}_Warm_Season,             !- Name
    Warm_Season_Sch,        !- Output:Variable or Output:Meter Index Key Name
    Schedule Value;  !- Output:Variable or Output:Meter Name                
  
EnergyManagementSystem:Sensor,
    #{CleanSystemName}_Cold_Season,             !- Name
    Cold_Season_Sch,        !- Output:Variable or Output:Meter Index Key Name
    Schedule Value;  !- Output:Variable or Output:Meter Name  
  
!- Internal Variables

EnergyManagementSystem:InternalVariable,
    #{CleanSystemName}_FanSP,           !- Name
    #{SystemName}_OA_Fan,        !- Internal Data Index Key Name
    Fan Nominal Pressure Rise;  !- Internal Data Type  
    
!- Actuators

EnergyManagementSystem:Actuator,
    #{CleanSystemName}_FanSP_Act,  !- Name
    #{SystemName}_OA_Fan,                   !- Actuated Component Unique Name
    Fan,             !- Actuated Component Type
    Fan Pressure Rise;     !- Actuated Component Control Type                               

!- Calling Manager      

EnergyManagementSystem:ProgramCallingManager,
    #{CleanSystemName}_ERV_IDEC_Control_Call,       !- Name
    AfterPredictorBeforeHVACManagers,  !- EnergyPlus Model Calling Point
    #{CleanSystemName}_ERV_IDEC_Control;   !- Program Name 1            
    
!- Program

EnergyManagementSystem:Program,
    #{CleanSystemName}_ERV_IDEC_Control, !- Name
    SET #{CleanSystemName}_ERV_SP = #{CleanSystemName}_Cold_Season * 253,
    SET #{CleanSystemName}_IDEC_SP = #{CleanSystemName}_Warm_Season * 295,
    SET #{CleanSystemName}_FanSP_Act = #{CleanSystemName}_FanSP + #{CleanSystemName}_ERV_SP,
    SET #{CleanSystemName}_FanSP_Act = #{CleanSystemName}_FanSP_Act + #{CleanSystemName}_IDEC_SP;
    
##enddef    
    
    